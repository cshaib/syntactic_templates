<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Explorer</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .explanation {
            margin-bottom: 2rem;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <h1 class="text-center mb-4">Template Explorer</h1>

        <div class="explanation bg-white p-4 rounded shadow-sm">
            <h2 class="h4">What is this?</h2>
            <p> This tool allows you to explore text from models that match to part-of-speech templates. 
                Select a dataset, model, and template to see snippets of text corresponding to the pos template. </p>
            <ul>
                <li><strong>Dataset:</strong> The source of the input data (e.g., CNN/DailyMail for news summarization).</li>
                <li><strong>Model:</strong> The LLM used to generate the output (e.g., GPT-4o, Llama-2).</li>
                <li><strong>Template:</strong> The part-of-speech pattern.</li>
            </ul>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <label for="dataset" class="form-label">Dataset:</label>
                <select id="dataset" class="form-select"></select>
            </div>
            <div class="col-md-4">
                <label for="model" class="form-label">Model:</label>
                <select id="model" class="form-select"></select>
            </div>
            <div class="col-md-4">
                <label for="template" class="form-label">Template:</label>
                <select id="template" class="form-select"></select>
            </div>
        </div>

        <div id="result" class="mt-4 p-3 bg-white rounded shadow-sm">
            <p class="text-muted">Loading...</p>
        </div>

        <div class="mt-4">
            <a href="https://cshaib.github.io/syntactic_templates/index.html" class="btn btn-primary">Back to Project Page</a>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const datasetSelect = document.getElementById('dataset');
        const modelSelect = document.getElementById('model');
        const templateSelect = document.getElementById('template');
        const resultDiv = document.getElementById('result');

        let combinations = {};
        const datasets = ['CNN_DailyMail', 'Rotten Tomatoes', 'Cochrane'];
        const models = ['GPT4-o', 'Llama-2-70B', 'Llama-3-70B', 'Mistral-7B', 'OLMo-7B'];

        // Function to load JSON file
        async function loadJSON(filename) {
            try {
                console.log(`Attempting to load: ${filename}`);
                const response = await fetch(filename);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const jsonContent = await response.json();
                console.log(`Successfully loaded: ${filename}`);
                return jsonContent;
            } catch (error) {
                console.error(`Error loading ${filename}:`, error);
                return {};
            }
        }

        // Function to populate dropdowns
        async function populateDropdowns() {
            datasets.forEach(dataset => {
                const option = document.createElement('option');
                option.value = dataset;
                option.textContent = dataset;
                datasetSelect.appendChild(option);
            });

            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });

            // Load all JSON files and populate combinations object
            for (const dataset of datasets) {
                for (const model of models) {
                    const filename = `web/data/${model}_${dataset}.json`;
                    const data = await loadJSON(filename);
                    if (!combinations[dataset]) combinations[dataset] = {};
                    combinations[dataset][model] = data;
                }
            }

            // Set default selections
            datasetSelect.value = datasets[0];
            modelSelect.value = models[0];
            await updateTemplates();
            templateSelect.value = templateSelect.options[1].value; // Select the first non-empty option
            updateResult();
        }

        async function updateTemplates() {
            const selectedDataset = datasetSelect.value;
            const selectedModel = modelSelect.value;

            templateSelect.innerHTML = '<option value="">Choose a template</option>';

            if (selectedDataset && selectedModel && combinations[selectedDataset][selectedModel]) {
                Object.keys(combinations[selectedDataset][selectedModel]).forEach(template => {
                    const option = document.createElement('option');
                    option.value = template;
                    option.textContent = template;
                    templateSelect.appendChild(option);
                });
            }
        }

        function updateResult() {
            const selectedDataset = datasetSelect.value;
            const selectedModel = modelSelect.value;
            const selectedTemplate = templateSelect.value;

            if (selectedDataset && selectedModel && selectedTemplate) {
                const selectedItem = combinations[selectedDataset][selectedModel][selectedTemplate];
                if (selectedItem && selectedItem.length > 0) {
                    // Display a random text from the list
                    const randomIndex = Math.floor(Math.random() * selectedItem.length);
                    resultDiv.innerHTML = `
                        <h3 class="h5 mb-3">Output:</h3>
                        <p class="mb-2"><strong>Dataset:</strong> ${selectedDataset}</p>
                        <p class="mb-2"><strong>Model:</strong> ${selectedModel}</p>
                        <p class="mb-2"><strong>Template:</strong> ${selectedTemplate}</p>
                        <p class="mt-3">${selectedItem[randomIndex]}</p>
                    `;
                } else {
                    resultDiv.innerHTML = '<p class="text-danger">No text available for this combination</p>';
                }
            } else {
                resultDiv.innerHTML = '<p class="text-muted">Please select a dataset, model, and template</p>';
            }
        }

        // Initialize dropdowns, load data, and show default view
        populateDropdowns().then(() => {
            console.log('Data loaded successfully');
        }).catch(error => {
            console.error('Error loading data:', error);
            resultDiv.innerHTML = '<p class="text-danger">Error loading data. Please try refreshing the page.</p>';
        });

        datasetSelect.addEventListener('change', async () => {
            await updateTemplates();
            updateResult();
        });
        modelSelect.addEventListener('change', async () => {
            await updateTemplates();
            updateResult();
        });
        templateSelect.addEventListener('change', updateResult);
    </script>
</body>
</html>